# xFGv2 Structural Levels System

Enhanced structural levels management system with PostgreSQL database integration, automatic CSV import from MotiveWave, and web-based manual input interface.

## 🚀 Key Features

### **Automated CSV Import**
- **File Monitoring**: Automatically scans designated folder for MotiveWave CSV exports
- **Background Processing**: Runs on Render as a background service
- **Validation**: Validates CSV structure and price data before import
- **Error Handling**: Moves failed files to error folder with detailed logs

### **Manual Pivot Entry**
- **Web Interface**: Clean, responsive UI for daily pivot level entry
- **Real-time Validation**: Validates level hierarchy (BA High > Pivot > BA Low)
- **Completeness Tracking**: Shows status of CSV vs manual levels
- **Multi-symbol Support**: ES and NQ support with symbol-specific rules

### **Database Integration**
- **PostgreSQL Backend**: Robust, scalable database storage
- **Performance Optimized**: Indexed queries for fast level lookups
- **Audit Trail**: Tracks who entered levels and when
- **Level Touch Tracking**: Records when price interacts with levels

### **Render Deployment Ready**
- **Environment Configuration**: Automatic setup via environment variables
- **Health Checks**: Built-in monitoring and validation
- **Scalable Architecture**: Separate web and worker services

## 📁 File Structure

```
xFGv2/
├── src/
│   ├── structural_levels_v2.py      # Core levels manager
│   ├── csv_file_monitor.py          # File monitoring service
│   └── ...
├── scripts/
│   ├── xfgv2_db_setup.py           # Database management
│   └── deploy_xfgv2_render.py      # Render deployment
├── templates/
│   └── levels_v2.html              # Web interface
├── examples/
│   └── xfgv2_usage_example.py      # Usage examples
├── web_app_levels_v2.py            # Flask web application
├── requirements_xfgv2.txt          # Dependencies
└── README_xFGv2.md                 # This file
```

## 🛠️ Setup Instructions

### **1. Database Setup**

```bash
# Create PostgreSQL database
createdb xfgv2

# Set environment variable
export DATABASE_URL="postgresql://user:pass@localhost/xfgv2"

# Initialize database tables
python scripts/xfgv2_db_setup.py create
```

### **2. Environment Configuration**

Create `.env` file:
```env
# Database
DATABASE_URL=postgresql://user:pass@host:5432/xfgv2

# CSV Monitoring
CSV_WATCH_FOLDER=/path/to/csv/folder
CSV_CHECK_INTERVAL=5
CSV_MAX_AGE_HOURS=24
ALLOWED_SYMBOLS=ES,NQ

# Web Interface
SECRET_KEY=your-secret-key
WEB_USERNAME=admin
WEB_PASSWORD=your-password

# Render (for deployment)
RENDER_SERVICE_TYPE=web
PORT=5002
```

### **3. Install Dependencies**

```bash
pip install -r requirements_xfgv2.txt
```

### **4. Local Development**

```bash
# Start web interface
python web_app_levels_v2.py

# OR start file monitor service
python -m src.csv_file_monitor

# OR run database setup
python scripts/xfgv2_db_setup.py --help
```

## 🌐 Render Deployment

### **1. Prepare for Deployment**

```bash
# Create render.yaml configuration
python scripts/deploy_xfgv2_render.py --create-config

# Run health check
python scripts/deploy_xfgv2_render.py --health-check
```

### **2. Deploy to Render**

1. **Create Render Services**:
   - Web Service: `xfgv2-web` (runs web interface)
   - Worker Service: `xfgv2-monitor` (runs CSV monitoring)
   - Database: `xfgv2-db` (PostgreSQL)

2. **Set Environment Variables**:
   ```
   DATABASE_URL: (auto-generated by Render database)
   CSV_WATCH_FOLDER: /tmp/csv_watch
   SECRET_KEY: (generate random)
   WEB_USERNAME: admin
   WEB_PASSWORD: (your password)
   ALLOWED_SYMBOLS: ES,NQ
   ```

3. **Deploy**:
   ```bash
   git add .
   git commit -m "Deploy xFGv2"
   git push origin main
   ```

## 📊 Daily Workflow

### **After Market Open (9:30 AM EST)**

1. **Export from MotiveWave**:
   - Export **ES data** to `ES_levels.csv` (or any filename containing "ES")
   - Export **NQ data** to `NQ_levels.csv` (or any filename containing "NQ") 
   - Save both files to designated CSV watch folder
   - System automatically imports within 5 minutes

2. **Verify CSV Import**:
   - Check web dashboard for CSV completion status
   - Each symbol shows status separately
   - Review imported MGI levels for accuracy

3. **Enter Pivot Levels**:
   - Access web interface
   - Select symbol (ES or NQ)
   - Input daily pivots: Pivot, Pivot High/Low, BA High/Low
   - Add weekly pivot if Monday
   - Repeat for both symbols
   - Submit and validate

4. **Confirm Readiness**:
   - Verify both ES and NQ show "Complete" status
   - Check validation passes for both symbols
   - System ready for trading signals

### **During Trading**

- System automatically tracks level touches
- Levels available via API for trading algorithms
- Monitor via web dashboard

## 🔧 API Reference

### **Manual Level Entry**
```http
POST /api/v2/manual-levels
Content-Type: application/json

{
  "symbol": "ES",
  "trading_date": "2024-01-15",
  "levels": {
    "pivot": 5825.75,
    "pivot_high": 5850.25,
    "pivot_low": 5800.50,
    "pivot_ba_high": 5875.00,
    "pivot_ba_low": 5775.25
  }
}
```

### **Get Levels for Date**
```http
GET /api/v2/levels/ES/2024-01-15

Response:
{
  "symbol": "ES",
  "trading_date": "2024-01-15",
  "levels": {
    "pivot": 5825.75,
    "overnight_high": 5850.25,
    "vwap": 5837.75,
    ...
  }
}
```

### **Completeness Status**
```http
GET /api/v2/completeness/ES?date=2024-01-15

Response:
{
  "symbol": "ES",
  "trading_date": "2024-01-15",
  "csv_complete": true,
  "manual_complete": true,
  "overall_complete": true,
  "missing_csv": [],
  "missing_manual": [],
  "total_levels": 12
}
```

### **Nearby Levels**
```http
GET /api/v2/nearby-levels?symbol=ES&price=5830.00&range=5.0

Response:
{
  "symbol": "ES",
  "reference_price": 5830.00,
  "range_points": 5.0,
  "nearby_levels": [
    {
      "level_type": "vwap",
      "price": 5832.25,
      "distance": 2.25,
      "source": "motivewave_csv",
      "touches": 3
    }
  ]
}
```

## 💾 Database Schema

### **StructuralLevelsTable**
```sql
CREATE TABLE structural_levels_v2 (
    id UUID PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,
    trading_date DATE NOT NULL,
    level_type VARCHAR(50) NOT NULL,
    price FLOAT NOT NULL,
    source VARCHAR(20) NOT NULL,     -- CSV, MANUAL, CALCULATED
    timeframe VARCHAR(20) NOT NULL,  -- DAILY, WEEKLY, MONTHLY
    description TEXT,
    touches INTEGER DEFAULT 0,
    last_touch_time TIMESTAMP,
    first_touch_time TIMESTAMP,
    is_validated BOOLEAN DEFAULT FALSE,
    validation_errors JSON,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    imported_by VARCHAR(50),
    hit_count INTEGER DEFAULT 0,
    reaction_strength FLOAT DEFAULT 0.0
);

-- Indexes for performance
CREATE INDEX idx_symbol_date ON structural_levels_v2(symbol, trading_date);
CREATE INDEX idx_symbol_date_type ON structural_levels_v2(symbol, trading_date, level_type);
```

## 🧪 Usage Examples

### **Basic Level Management**
```python
from src.structural_levels_v2 import StructuralLevelsManagerV2

# Initialize manager
manager = StructuralLevelsManagerV2(DATABASE_URL)

# Add manual levels
result = manager.add_manual_levels('ES', date.today(), {
    'pivot': 5825.75,
    'pivot_high': 5850.25,
    'pivot_low': 5800.50
})

# Get nearby levels
nearby = manager.get_nearby_levels('ES', 5830.00, range_points=5.0)
```

### **CSV Import**
```python
from src.structural_levels_v2 import import_motivewave_csv

result = import_motivewave_csv(DATABASE_URL, 'path/to/levels.csv')
print(f"Imported {result['imported_count']} levels")
```

### **File Monitoring**
```python
from src.csv_file_monitor import CSVFileMonitor, MonitorConfig

config = MonitorConfig(
    database_url=DATABASE_URL,
    watch_folder='/path/to/csv/folder'
)

monitor = CSVFileMonitor(config)
monitor.start_monitoring()  # Runs continuously
```

## 🔍 Monitoring & Debugging

### **Health Checks**
```bash
# Check database connection
python scripts/xfgv2_db_setup.py check

# View database info
python scripts/xfgv2_db_setup.py info

# Run deployment health check
python scripts/deploy_xfgv2_render.py --health-check
```

### **Logs**
- Web service logs: Available via Render dashboard
- File monitor logs: Check service logs in Render
- Database logs: PostgreSQL logs via Render database dashboard

### **Common Issues**

1. **CSV Files Not Processing**:
   - Check folder permissions
   - Verify CSV format matches expected structure
   - Check error folder for failed files

2. **Level Validation Fails**:
   - Ensure pivot hierarchy: BA High > Pivot > BA Low
   - Check price ranges are reasonable
   - Verify all required fields are present

3. **Database Connection Issues**:
   - Verify DATABASE_URL format
   - Check database service status
   - Test connection with health check

## 🚦 Status Indicators

### **Web Dashboard**
- 🟢 **Complete**: All required levels loaded and validated
- 🟡 **Partial**: Some levels missing (CSV or manual)
- 🔴 **Incomplete**: Missing critical levels or validation failed

### **Required Levels**

**CSV Levels (from MotiveWave)**:
- overnight_high, overnight_low
- vwap, vah, val, poc
- previous_day_high, previous_day_low, previous_day_close

**Manual Levels (entered at 9:30am)**:
- pivot, pivot_high, pivot_low
- pivot_ba_high, pivot_ba_low
- weekly_pivot (Mondays only)

## 📈 Performance & Scaling

- **Database**: Optimized with indexes for sub-millisecond level lookups
- **File Processing**: Handles hundreds of CSV files per day
- **Web Interface**: Responsive design works on all devices
- **Memory Usage**: Efficient queries minimize memory footprint
- **Concurrent Access**: Supports multiple users via web interface

## 🔒 Security

- **Authentication**: Username/password login for web interface
- **Database**: Secured PostgreSQL with connection pooling
- **Input Validation**: All user inputs validated and sanitized
- **File Safety**: CSV files validated before processing
- **Environment Variables**: Sensitive data stored securely

## 🤝 Integration

### **With Trading Systems**
```python
# Get current levels for trading decisions
levels = manager.get_levels_for_date('ES', date.today())
pivot = levels.get('pivot')
pivot_high = levels.get('pivot_high')

# Check if price is near important level
nearby = manager.get_nearby_levels('ES', current_price, range_points=2.0)
if nearby:
    print(f"Price near {nearby[0]['level_type']} at {nearby[0]['price']}")
```

### **With MotiveWave**
1. Configure MotiveWave to export CSV files to watched folder
2. System automatically imports new files
3. Levels available immediately for trading algorithms

---

## 🎯 Next Steps

1. **Deploy to Render**: Follow deployment instructions
2. **Configure MotiveWave**: Set up CSV export to watched folder
3. **Test Workflow**: Run through daily morning routine
4. **Monitor Performance**: Check logs and health metrics
5. **Scale as Needed**: Add more symbols or advanced features

For questions or issues, check the logs or run health checks to diagnose problems.